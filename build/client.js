!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):n.Schnack=t()}(this,function(){"use strict";var E="function"==typeof fetch?fetch.bind():function(s,i){return i=i||{},new Promise(function(n,t){var e=new XMLHttpRequest;for(var a in e.open(i.method||"get",s,!0),i.headers)e.setRequestHeader(a,i.headers[a]);function o(){var a,s=[],i=[],c={};return e.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,function(n,t,e){s.push(t=t.toLowerCase()),i.push([t,e]),a=c[t],c[t]=a?a+","+e:e}),{ok:2==(e.status/100|0),status:e.status,statusText:e.statusText,url:e.responseURL,clone:o,text:function(){return Promise.resolve(e.responseText)},json:function(){return Promise.resolve(e.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([e.response]))},headers:{keys:function(){return s},entries:function(){return i},get:function(n){return c[n.toLowerCase()]},has:function(n){return n.toLowerCase()in c}}}}e.withCredentials="include"==i.credentials,e.onload=function(){n(o())},e.onerror=t,e.send(i.body||null)})};function S(n){var e,a="";return a+='<ul class="schnack-comments">\n    ',n.comments.forEach(function(t){a+='\n        <li id="comment-'+(null==(e=t.id)?"":e)+'" data-id="'+(null==(e=t.id)?"":e)+'" class="schnack-comment',t.approved||t.trusted||(a+=" schnack-not-approved"),a+='">\n            <div class="schnack-comment-inner">\n                <div class="schnack-dateline">\n                    <span class="schnack-author">',t.author_url&&(a+='<a href="'+(null==(e=t.author_url)?"":e)+'" target="_blank">'),a+=null==(e=t.display_name||t.name)?"":e,t.author_url&&(a+="</a>"),a+="</span>\n                    ",n.user&&n.user.admin&&!t.trusted&&["trust","block"].forEach(function(n){a+='\n                    <button class="schnack-action" data-target="'+(null==(e=t.user_id)?"":e)+'" data-class="user" data-action="'+(null==(e=n)?"":e)+'"><i class="icon schnack-icon-'+(null==(e=n)?"":e)+'"></i> <span>'+(null==(e=n)?"":e)+"</span></button>\n                    "}),a+='\n                    <span class="schnack-date"><a href="#comment-'+(null==(e=t.id)?"":e)+'">'+(null==(e=t.created_at_s)?"":e)+'</a></span>\n                </div>\n                <blockquote class="schnack-body">\n                    '+(null==(e=t.comment)?"":e)+"\n                </blockquote>\n                ",t.approved||t.trusted?n.user&&(a+='\n                <button class="schnack-reply" data-reply-to="'+(null==(e=t.id)?"":e)+'">'+(null==(e=n.partials.Reply)?"":e)+"</button>\n                "):(a+='\n                <div class="schnack-awaiting-approval">\n                    ',n.user&&n.user.admin&&["approve","reject"].forEach(function(n){a+='\n                    <button class="schnack-action" data-target="'+(null==(e=t.id)?"":e)+'" data-class="comment" data-action="'+(null==(e=n)?"":e)+'"><i class="icon schnack-icon-'+(null==(e=n)?"":e)+'"></i> <span>'+(null==(e=n)?"":e)+"</span></button>\n                    "}),a+="\n                    "+(null==(e=n.user.admin?n.partials.AdminApproval:n.partials.WaitingForApproval)?"":e)+"\n                </div>\n                "),a+="\n                ",n.user&&n.user.admin&&(a+='\n                <button class="schnack-edit" data-target="'+(null==(e=t.id)?"":e)+'"><i class="icon schnack-icon-edit"></i> <span>编辑</span></button>\n                <button class="schnack-action" data-target="'+(null==(e=t.id)?"":e)+'" data-class="comment" data-action="remove"><i class="icon schnack-icon-remove"></i> <span>删除</span></button>\n                '),a+="\n            </div>\n            ",n.replies[t.id]&&(n.comments=n.replies[t.id],a+="\n            "+(null==(e=n.comments_tpl(n))?"":e)+"\n            "),a+="\n        </li>\n    "}),a+="\n</ul>\n"}var L=function(n){return document.querySelector(n)},_=function(n){return document.querySelectorAll(n)},n=function(n){this.options=n,this.options.endpoint=n.host+"/comments/"+n.slug,this.initialized=!1,this.firstLoad=!0;var t=new URL(n.host);if("localhost"!==t.hostname)try{document.domain=t.hostname.split(".").slice(1).join(".")}catch(n){}this.refresh()};return n.prototype.refresh=function(){var y=this,n=this.options,k=n.target,v=n.slug,b=n.host,g=n.endpoint,w=n.partials;E(g,{credentials:"include",headers:{"Content-Type":"application/json"}}).then(function(n){return n.json()}).then(function(n){n.comments_tpl=S,n.partials=w,L(k).innerHTML=function(e){var a,s="";e.user?(s+="\n    ",e.user.admin&&(s+='\n    <div class="schnack-settings">\n        <button class="schnack-action" data-target="notification" data-class="setting" data-action="true">'+(null==(a=e.partials.UnMute)?"":a)+'</button>\n        <button class="schnack-action" data-target="notification" data-class="setting" data-action="false">'+(null==(a=e.partials.Mute)?"":a)+"</button>\n    </div>\n    "),s+='\n<div class="schnack-login-status">\n    '+(null==(a=e.partials.LoginStatus.replace("%USER%",e.user.name))?"":a)+'\n</div>\n<div class="schnack-above">\n    <div class="schnack-form">\n        <textarea class="schnack-body" placeholder="'+(null==(a=e.partials.PostComment)?"":a)+'"></textarea>\n        <blockquote class="schnack-body" style="display:none"></blockquote>\n        <br>\n        <button class="schnack-preview">'+(null==(a=e.partials.Preview)?"":a)+'</button>\n        <button style="display:none" class="schnack-write">'+(null==(a=e.partials.Edit)?"":a)+'</button>&nbsp;\n        <button class="schnack-send-comment schnack-button">'+(null==(a=e.partials.SendComment)?"":a)+'</button>&nbsp;\n        <button class="schnack-cancel-reply" style="display:none">'+(null==(a=e.partials.Cancel)?"":a)+"</button>\n    </div>\n</div>\n"):(s+='\n<div class="schnack-signin">\n'+(null==(a=e.partials.SignInVia)?"":a)+"<br>\n",e.auth.forEach(function(n,t){s+="\n    "+(null==(a=t?e.partials.Or:"")?"":a)+'<button class="schnack-signin-'+(null==(a=n.id)?"":a)+'"><i class="icon schnack-icon-'+(null==(a=n.id)?"":a)+'"></i> '+(null==(a=n.name)?"":a)+"</button>\n"}),s+="\n"),s+="\n</div>\n";var t=[];return e.replies={},e.comments.forEach(function(n){n.reply_to?(e.replies[n.reply_to]||(e.replies[n.reply_to]=[]),e.replies[n.reply_to].push(n)):t.push(n)}),e.comments=t,s+="\n"+(null==(a=e.comments_tpl(e))?"":a)+'\n<style type="text/css">\n.schnack-action > * { pointer-events: none; }\n</style>\n'}(n);var t=L(k+" div.schnack-above"),i=L(k+" div.schnack-form"),c=L(k+" textarea.schnack-body"),e=L(k+" .schnack-form blockquote.schnack-body"),a=window.localStorage.getItem("schnack-draft-"+v);a&&c&&(c.value=a);var s=L(k+" .schnack-button"),o=L(k+" .schnack-preview"),l=L(k+" .schnack-write"),r=L(k+" .schnack-cancel-reply"),d=_(k+" .schnack-reply"),u=_(k+" .schnack-edit");if(s&&(s.addEventListener("click",function(n){var t=c.value;E(g,{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:t,replyTo:i.dataset.reply,editId:i.dataset.edit})}).then(function(n){return n.json()}).then(function(n){c.value="",window.localStorage.setItem("schnack-draft-"+v,c.value),n.id&&(y.firstLoad=!0,window.location.hash="#comment-"+n.id),y.refresh()})}),o.addEventListener("click",function(n){var t=c.value;c.style.display="none",o.style.display="none",e.style.display="block",l.style.display="inline",E(b+"/markdown",{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:t})}).then(function(n){return n.json()}).then(function(n){e.innerHTML=n.html})}),l.addEventListener("click",function(n){c.style.display="inline",o.style.display="inline",e.style.display="none",l.style.display="none"}),c.addEventListener("keyup",function(){window.localStorage.setItem("schnack-draft-"+v,c.value)}),d.forEach(function(n){n.addEventListener("click",function(){delete i.dataset.edit,i.dataset.reply=n.dataset.replyTo,r.style.display="inline-block",n.parentElement.appendChild(i),i.parentElement.querySelector(".schnack-body").style.display="block"})}),r.addEventListener("click",function(){i.parentElement.querySelector(".schnack-body").style.display="block",t.appendChild(i),delete i.dataset.reply,delete i.dataset.edit,r.style.display="none"}),u.forEach(function(s){s.addEventListener("click",function(){var n=i.parentElement.querySelector(".schnack-body");n&&(n.style.display="block");var a=s.dataset;E(b+"/get_comment/"+a.target,{credentials:"include",method:"GET",headers:{"Content-Type":"application/json"}}).then(function(n){return n.json()}).then(function(n){delete i.dataset.reply,i.dataset.edit=a.target,c.value=n.comment.comment,r.style.display="inline-block";var t=s.parentElement,e=t.querySelector(".schnack-body");e.style.display="none",t.insertBefore(i,e.nextSibling)})})})),n.user){var h=L("a.schnack-signout");h&&h.addEventListener("click",function(n){n.preventDefault(),E(b+"/signout",{credentials:"include",headers:{"Content-Type":"application/json"}}).then(function(){return y.refresh()})})}else n.auth.forEach(function(a){var n=L(k+" .schnack-signin-"+a.id);n&&n.addEventListener("click",function(n){var t=function(n){void 0===n&&(n="");var t=window.open(b+"/auth/"+a.id+(n?"/d/"+n:""),a.name+" Sign-In","resizable,scrollbars,status,width=600,height=500");window.__schnack_wait_for_oauth=function(){t.close(),y.refresh()}};if("mastodon"===a.id){var e=window.prompt("Please enter the domain name of the Mastodon instance you want to sign in with:","mastodon.social");E("https://"+e+"/api/v1/instance").then(function(n){return n.json()}).then(function(n){n.uri===e?t(e):window.alert('We could not find a Mastodon instance at "'+e+'". Please try again.')}).catch(function(n){console.error(n),window.alert('We could not find a Mastodon instance at "'+e+'". Please try again.')})}else t()})});if(n.user&&n.user.admin){if(!y.initialized){var p=document.createElement("script");p.setAttribute("src",b+"/push.js"),document.head.appendChild(p),y.initialized=!0}var f=function(n){if(confirm("确认吗？")){var t=n.target.dataset;E(b+"/"+t.class+"/"+t.target+"/"+t.action,{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:""}).then(function(){return y.refresh()})}};document.querySelectorAll(".schnack-action").forEach(function(n){n.addEventListener("click",f)})}if(y.firstLoad&&window.location.hash.match(/^#comment-\d+$/)){var m=document.querySelector(window.location.hash);m&&(m.scrollIntoView(),m.classList.add("schnack-highlight")),y.firstLoad=!1}})},n});
